import os,time,json,pymysql;from web3 import Web3;w3=Web3(Web3.HTTPProvider(os.getenv('RPC_URL')));conn=pymysql.connect(host=os.getenv('DB_HOST'),user=os.getenv('DB_USER'),passwd=os.getenv('DB_PASS'),db=os.getenv('DB_NAME'));contract_address="0xYourDeployedContractAddress";contract_abi=json.loads('[{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"payer","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":true,"internalType":"bytes32","name":"plan","type":"bytes32"}],"name":"PaymentReceived","type":"event"}]');contract=w3.eth.contract(address=contract_address,abi=contract_abi);plan_map={Web3.keccak(text="standard").hex():("standard",15),Web3.keccak(text="premium").hex():("premium",40),Web3.keccak(text="ultra").hex():("ultra",90)};print("Listener Started...");while True:events=contract.events.PaymentReceived().get_logs(fromBlock=w3.eth.block_number-100);for e in events:payer=e['args']['payer'];plan_hash=e['args']['plan'].hex();amount=e['args']['amount']/10**6;if plan_hash in plan_map:plan=plan_map[plan_hash][0];cursor=conn.cursor();cursor.execute("SELECT id FROM users WHERE wallet_address=%s",(payer,));user=cursor.fetchone();if user:cursor.execute("UPDATE users SET subscription_plan=%s, expires_at=DATE_ADD(NOW(), INTERVAL 1 MONTH) WHERE id=%s",(plan,user[0]));print(f"Updated User {user[0]} to {plan}");conn.commit();time.sleep(10);
