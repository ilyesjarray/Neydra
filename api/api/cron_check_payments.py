import os, json, pymysql;from web3 import Web3;from datetime import datetime, timedelta;DB_URL = os.environ.get("DATABASE_URL");# Setup MySQL connectionconn = pymysql.connect(host=os.getenv('DB_HOST'),user=os.getenv('DB_USER'),passwd=os.getenv('DB_PASS'),db=os.getenv('DB_NAME'));w3 = Web3(Web3.HTTPProvider('https://cloudflare-eth.com')); # Free Ethereum RPCcontract_address = "0xYourDeployedContractAddress";contract_abi = json.loads('[{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"payer","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":true,"internalType":"bytes32","name":"plan","type":"bytes32"}],"name":"PaymentReceived","type":"event"}]');contract = w3.eth.contract(address=contract_address, abi=contract_abi);plan_map = {Web3.keccak(text="standard").hex(): "standard", Web3.keccak(text="premium").hex(): "premium", Web3.keccak(text="ultra").hex(): "ultra"};cursor = conn.cursor();# Get last checked block from DBcursor.execute("SELECT block_number FROM transactions ORDER BY id DESC LIMIT 1");row = cursor.fetchone();last_block = row[0] if row else w3.eth.block_number - 1000;# Scan events from last_block to currentblock = w3.eth.block_number;events = contract.events.PaymentReceived().get_logs(fromBlock=last_block, toBlock=block);for e in events:payer = e['args']['payer'];amount = e['args']['amount'] / 10**6;plan_hash = e['args']['plan'].hex();plan = plan_map.get(plan_hash, "unknown");if plan != "unknown":    # Check if user exists (simplified logic, matching wallet address)    cursor.execute("UPDATE users SET subscription_plan=%s, expires_at=DATE_ADD(NOW(), INTERVAL 1 MONTH) WHERE wallet_address=%s", (plan, payer));    print(f"Updated {payer} to {plan}");conn.commit();# Update logcursor.execute("INSERT INTO transactions (tx_hash, from_address, to_address, amount, block_number) VALUES (%s, %s, %s, %s, %s)", ("cron_job", "system", "system", 0, block));conn.commit();conn.close();print("Cron Job Executed Successfully");return {"statusCode": 200, "body": "Success"}
