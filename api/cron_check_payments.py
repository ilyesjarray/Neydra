import os, json;from web3 import Web3;from libsql_client import create_client;def handler(event, context):url = os.environ.get("TURSO_URL");token = os.environ.get("TURSO_TOKEN");client = create_client(url, auth_token=token);w3 = Web3(Web3.HTTPProvider('https://cloudflare-eth.com'));contract_address = os.getenv("CONTRACT_ADDRESS");contract_abi = json.loads('[{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"payer","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":true,"internalType":"bytes32","name":"plan","type":"bytes32"}],"name":"PaymentReceived","type":"event"}]');contract = w3.eth.contract(address=contract_address, abi=contract_abi);# Get last block from Tursortx = client.execute("SELECT block_number FROM transactions ORDER BY id DESC LIMIT 1");last_block = int(tx.rows[0]['block_number']) if tx.rows else w3.eth.block_number - 1000;current_block = w3.eth.block_number;events = contract.events.PaymentReceived().get_logs(fromBlock=last_block, toBlock=current_block);for e in events:payer = e['args']['payer'];plan = 'standard';# Update user in Tursoclient.execute("UPDATE users SET subscription_plan = ?, expires_at = datetime('now', '+1 month') WHERE wallet_address = ?", [plan, payer]);# Logclient.execute("INSERT INTO transactions (tx_hash, from_address, to_address, amount, block_number) VALUES (?, ?, ?, ?, ?)", ["cron_update", "0x0", "0x0", 0, current_block]);return {"statusCode": 200, "body": "Scanned blocks " + str(last_block) + " to " + str(current_block)}
