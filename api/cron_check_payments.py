import os, json, pymysql;from web3 import Web3;def handler(event, context):conn = pymysql.connect(host=os.getenv('DB_HOST'),user=os.getenv('DB_USER'),passwd=os.getenv('DB_PASS'),db=os.getenv('DB_NAME'),connect_timeout=10);w3 = Web3(Web3.HTTPProvider('https://cloudflare-eth.com'));contract_address = os.getenv('CONTRACT_ADDRESS');cursor = conn.cursor();last_block = int(os.getenv('LAST_BLOCK', w3.eth.block_number - 1000));current_block = w3.eth.block_number;contract_abi = json.loads('[{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"payer","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":true,"internalType":"bytes32","name":"plan","type":"bytes32"}],"name":"PaymentReceived","type":"event"}]');contract = w3.eth.contract(address=contract_address, abi=contract_abi);events = contract.events.PaymentReceived().get_logs(fromBlock=last_block, toBlock=current_block);for e in events:payer = e['args']['payer'];plan = 'standard' if e['args']['plan'].hex() == Web3.keccak(text="standard").hex() else 'premium';cursor.execute("UPDATE users SET subscription_plan=%s, expires_at=DATE_ADD(NOW(), INTERVAL 1 MONTH) WHERE wallet_address=%s", (plan, payer));conn.commit();cursor.execute("INSERT INTO transactions (tx_hash, from_address, to_address, amount, block_number) VALUES (%s, %s, %s, %s, %s)", ("cron_update", "0x0", "0x0", 0, current_block));conn.commit();conn.close();return {"statusCode": 200, "body": f"Scanned blocks {last_block} to {current_block}"}
