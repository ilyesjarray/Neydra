import os, json;from web3 import Web3;from libsql_client import create_client;def handler(event, context):w3=Web3(Web3.HTTPProvider('https://cloudflare-eth.com'));client=create_client(os.environ.get("TURSO_URL"),auth_token=os.environ.get("TURSO_TOKEN"));contract=w3.eth.contract(address=os.getenv("CONTRACT_ADDRESS"),abi=json.loads('[{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"payer","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":true,"internalType":"bytes32","name":"plan","type":"bytes32"}],"name":"PaymentReceived","type":"event"}]'));last_block=w3.eth.block_number-1000;events=contract.events.PaymentReceived().get_logs(fromBlock=last_block,toBlock=w3.eth.block_number);updated=False;for e in events:payer=e['args']['payer'];amount=e['args']['amount'];if amount==15000000:client.execute("UPDATE users SET subscription_plan='standard' WHERE wallet_address=?",[payer]);updated=True;elif amount==40000000:client.execute("UPDATE users SET subscription_plan='premium' WHERE wallet_address=?",[payer]);updated=True;return {"statusCode":200,"body":"Scanned Blockchain & Updated Plan"}
