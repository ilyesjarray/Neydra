import os, json;from web3 import Web3;from libsql_client import create_client;def handler(event, context):w3 = Web3(Web3.HTTPProvider('https://cloudflare-eth.com'));client = create_client(os.environ.get("TURSO_URL"), auth_token=os.environ.get("TURSO_TOKEN"));contract = w3.eth.contract(address=os.getenv("CONTRACT_ADDRESS"), abi=json.loads('[{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"payer","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":true,"internalType":"bytes32","name":"plan","type":"bytes32"}],"name":"PaymentReceived","type":"event"}]'));current_block = w3.eth.block_number;events = contract.events.PaymentReceived().get_logs(fromBlock=current_block-500, toBlock=current_block);found = False;for e in events:payer = e['args']['payer'];amount = e['args']['amount'];# If user pays 15 USDT (Standard)if amount == 15000000: client.execute("UPDATE users SET subscription_plan = 'standard' WHERE wallet_address = ?", [payer]);found = True;elif amount == 40000000: client.execute("UPDATE users SET subscription_plan = 'premium' WHERE wallet_address = ?", [payer]);found = True;return {"statusCode": 200, "body": "Payment verified. Access unlocked."}
