import os, json;from web3 import Web3;from libsql_client import create_client;def handler(event, context):try:w3=Web3(Web3.HTTPProvider('https://cloudflare-eth.com'));client=create_client(os.getenv("TURSO_URL"),auth_token=os.getenv("TURSO_TOKEN"));if not os.getenv("CONTRACT_ADDRESS"):return {"statusCode":500,"body":"Error: CONTRACT_ADDRESS is missing in Vercel Env Vars"};contract=w3.eth.contract(address=os.getenv("CONTRACT_ADDRESS"),abi=json.loads('[{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"payer","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":true,"internalType":"bytes32","name":"plan","type":"bytes32"}],"name":"PaymentReceived","type":"event"}]'));last_block=w3.eth.block_number-1000;events=contract.events.PaymentReceived().get_logs(fromBlock=last_block,to_block=w3.eth.block_number);count=0;for e in events:payer=e['args']['payer'];amount=e['args']['amount'];if amount==15000000:client.execute("UPDATE users SET subscription_plan='standard' WHERE wallet_address=?",[payer]);count+=1;elif amount==40000000:client.execute("UPDATE users SET subscription_plan='premium' WHERE wallet_address=?",[payer]);count+=1;return {"statusCode":200,"body":f"Success. Checked {count} payments."};except Exception as e:return {"statusCode":500,"body":"Backend Error: "+str(e)}
